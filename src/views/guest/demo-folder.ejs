<%
const formatBytes = (bytes, decimals = 2) => {
  if (!bytes) return '0 Bytes';

  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

  const i = Math.floor(Math.log(bytes) / Math.log(k));

  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
%>

<%- include('../partials/header', { title: folder ? folder.name : 'Folder' }) %>

<main class="max-w-7xl mx-auto px-6 py-12">
  <div class="mb-6">
    <a href="/guest" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </a>
  </div>

  <% if (folder) { %>
  <header class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-10 gap-4">
    <div>
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight mb-1"><%= folder.name %></h1>
      <p class="text-gray-500 text-sm">
        <time datetime="<%= folder.createdAt ? folder.createdAt.toISOString() : '' %>">
          Created on <%= folder.createdAt ? folder.createdAt.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : '' %>
        </time>
      </p>
    </div>
  </header>
  <% } %>

  <section class="mb-10">
    <% if (folder && Array.isArray(folder.children) && folder.children.length > 0) { %>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
      <% folder.children.forEach(child => { %>
      <a href="/folders/<%= child.id %>" class="block border rounded-lg p-4 hover:shadow-lg transition-shadow bg-white">
        <div class="flex items-center mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-5-4H7a2 2 0 00-2 2v3h16V5a2 2 0 00-2-2z" />
          </svg>
          <h3 class="font-semibold text-lg text-gray-900 truncate"><%= child.name %></h3>
        </div>
        <p class="text-sm text-gray-500">
          Created: <%= child.createdAt ? new Date(child.createdAt).toLocaleDateString() : '-' %>
        </p>
      </a>
      <% }) %>
    </div>
    <% } else { %>
    <p class="text-gray-500 italic">No subfolders found.</p>
    <% } %>
  </section>

  <section class="mb-10">
    <% if (folder && Array.isArray(items) && items.length > 0) { %>
    <div class="space-y-4">
      <% items.forEach(file => { %>
      <div class="flex items-center justify-between border rounded-lg p-4 bg-white hover:shadow-md transition-shadow">
        <div class="flex items-center space-x-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h10v10H7z" />
          </svg>
          <div>
            <p class="font-medium text-gray-900 truncate"><%= file.name %></p>
            <p class="text-xs text-gray-500">
              Size: <%= formatBytes(file.size) %> |
              Created: <%= file.createdAt ? new Date(file.createdAt).toLocaleDateString() : '-' %>
            </p>
          </div>
        </div>
        <div class="flex flex-wrap justify-end gap-3">
          <a href="/guest/folder/<%= folder.id %>/file/<%= encodeURIComponent(file.name) %>" class="text-blue-600 hover:text-blue-800 font-medium">
            View
          </a>
          <a href="/guest/folder/<%= folder.id %>/file/<%= encodeURIComponent(file.name) %>/download" class="text-blue-600 hover:underline">Download</a>
        </div>
      </div>
      <% }) %>
    </div>
    <% } else { %>
    <p class="text-gray-500 italic">No files found in this folder.</p>
    <% } %>
  </section>
</main>

<%- include('../partials/footer') %>